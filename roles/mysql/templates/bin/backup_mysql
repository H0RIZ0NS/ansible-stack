#!/usr/bin/env bash

set -Eeu -o pipefail

log() {
  local log_level="$1"
  local log_msg="$2"

  printf "\n[${log_level^^}] ${log_msg}\n\n"
}

dump_db() {
  local db_name="$1"
  local dump_path="{{ mysql_backup_directory }}/${db_name}/${db_name}.{{ mysql_backup_suffix }}"

  if [[ -z "${db_name// }" ]]; then
    return 0
  fi

  log info "Dumping database \`${db_name}\`â€¦"

  mysqldump \
    --socket={{ mysql_socket_path }} \
    --result-file="$dump_path" \
    --verbose \
    --databases "$db_name"
}

dump_databases() {
  while read db_name; do
    dump_db "$db_name"
  done \
    < {{ mysql_database_list_path }}
}

dump_databases
