#!/usr/bin/bash

set -Eeu -o pipefail

_log() {
  printf "\n== ${1}â€¦\n\n"
}

_dump_db() {
  local db_name="$1"

  if [[ -z "$db_name" ]]; then
    _log '[WARNING] Empty database name, skipping'

    return 1
  fi

  _log "Dumping database <${db_name}>"

  mysqldump --verbose --socket="$MYSQL_SOCKET_PATH" --databases "$db_name" \
  > "${MYSQL_BACKUP_STORAGE_DIR}/${db_name}.sql"
}

print_header() {
  echo
  echo '**********************************************'
  echo "== MySQL backup [$(date --rfc-3339='seconds')] =="
  echo '**********************************************'
}

dump_databases() {
  while read db_name; do
    _dump_db "$db_name"
  done \
  < "$MYSQL_DATABASE_LIST_PATH"
}

rotate_backups() {
  _log 'Rotating database backups'

  logrotate --verbose "$MYSQL_BACKUP_ROTATE_CONF_PATH"
}

main() {
  print_header
  dump_databases
  rotate_backups
}

main
