#!/usr/bin/env bash

set -Eeu -o pipefail

declare -r BACKUP_INCLUDE_LIST_PATH={{ backup_include_list_path }}
declare -r BACKUP_EXCLUDE_LIST_PATH={{ backup_exclude_list_path }}

source {{ backup_lib_path }}

init_repository() {
  _log 'Checking if the Restic repository is initialized'

  /usr/bin/restic snapshots &> /dev/null || /usr/bin/restic init --verbose
}

perform_backup() {
  _log 'Starting the server’s backup'

  /usr/bin/restic backup \
    --verbose \
    --one-file-system \
    --files-from="$BACKUP_INCLUDE_LIST_PATH" \
    --exclude-file="$BACKUP_EXCLUDE_LIST_PATH"
}

rotate_snapshots() {
  _log 'Purging old snapshots'

  /usr/bin/restic forget --verbose --prune --keep-within={{ backup_retention_days }}d
}

check_repository() {
  _log 'Checking the repository’s integrity'

  /usr/bin/restic check
}

main() {
  _export_credentials
  init_repository
  perform_backup
  rotate_snapshots
  check_repository
}

main
