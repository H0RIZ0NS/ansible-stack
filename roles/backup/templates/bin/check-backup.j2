#!/usr/bin/bash

set -Eeu -o pipefail

_log() {
  printf "\n== ${1}\n\n"
}

export_credentials() {
  if [[ ! -f "$BACKUP_CREDENTIALS_PATH" || ! -r "$BACKUP_CREDENTIALS_PATH" ]]; then
    _log "[ERROR] No credential file could be found at ${BACKUP_CREDENTIALS_PATH}"

    exit 1
  fi

  set -a
  source "$BACKUP_CREDENTIALS_PATH"
  set +a
}

deep_check_repository() {
  restic check --read-data
}

main() {
  export_credentials
  deep_check_repository
}

main
