#!/usr/bin/bash

set -Eeu -o pipefail

declare -r BACKUP_CREDENTIALS_PATH="${HOME}/.backup.creds"

_log() {
  printf "\n== ${1}…\n\n"
}

print_header() {
  echo
  echo '****************************************************************'
  echo "== Backup repository’s deep check [$(date --rfc-3339='seconds')] =="
  echo '****************************************************************'
  echo
}

export_credentials() {
  if [[ ! -f "$BACKUP_CREDENTIALS_PATH" || ! -r "$BACKUP_CREDENTIALS_PATH" ]]; then
    _log "[ERROR] No credential file could be found at ${BACKUP_CREDENTIALS_PATH}"

    exit 1
  fi

  set -a
  source "$BACKUP_CREDENTIALS_PATH"
  set +a
}

deep_check_repository() {
  restic check --read-data
}

main() {
  print_header
  export_credentials
  deep_check_repository
}

main
