#!/usr/bin/bash

set -Eeu -o pipefail

declare -r BACKUP_CREDENTIALS_PATH="${HOME}/.backup.creds"

_log() {
  printf "\n== ${1}\n\n"
}

export_credentials() {
  if [[ ! -f "$BACKUP_CREDENTIALS_PATH" || ! -r "$BACKUP_CREDENTIALS_PATH" ]]; then
    _log "[ERROR] No credential file could be found at ${BACKUP_CREDENTIALS_PATH}"

    exit 1
  fi

  set -a
  source "$BACKUP_CREDENTIALS_PATH"
  set +a
}

init_repository() {
  _log 'Checking if the Restic repository is initialized'

  restic snapshots &> /dev/null || restic init --verbose
}

perform_backup() {
  _log 'Starting the server’s backup'

  restic backup \
    --verbose \
    --one-file-system \
    --files-from="$BACKUP_INCLUDE_LIST_PATH" \
    --exclude-file="$BACKUP_EXCLUDE_LIST_PATH"
}

rotate_snapshots() {
  _log 'Purging old snapshots'

  restic forget --verbose --prune --keep-within={{ backup_retention_days }}d
}

check_repository() {
  _log 'Checking the repository’s integrity'

  restic check
}

main() {
  export_credentials
  init_repository
  perform_backup
  rotate_snapshots
  check_repository
}

main
